{% extends 'layout/base.html' %}
{% block content %}
<div class="page-header">
    <h1>–ê–Ω–∞–ª–∏–∑ –∑–¥–æ—Ä–æ–≤—å—è —Ä–∞—Å—Ç–µ–Ω–∏–π</h1>
    <p class="muted">–û—Ü–µ–Ω–∫–∞ –ø–æ RGB –∏–Ω–¥–µ–∫—Å–∞–º ExG –∏ VARI. NDVI –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ –¥–ª—è –º—É–ª—å—Ç–∏—Å–ø–µ–∫—Ç—Ä–∞.</p>
</div>

<div class="card">
    <form id="analyzeForm">
        <div class="field">
            <label for="plot_name">
                <span>üåæ</span>
                <span>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
            </label>
            <input type="text" name="plot_name" id="plot_name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–ª–µ A, –£—á–∞—Å—Ç–æ–∫ 1">
        </div>

        <div class="field">
            <label for="file">
                <span>üì∑</span>
                <span>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (jpg/png)</span>
            </label>
            <div style="position: relative;">
                <input type="file" name="file" id="file" accept="image/*" style="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2;">
                <div id="fileDisplay" style="display: flex; align-items: center; gap: 12px; padding: 16px; border: 2px dashed var(--border-color); border-radius: var(--border-radius-sm); background: var(--bg-secondary); transition: var(--transition); cursor: pointer;">
                    <div style="font-size: 32px;">üìÅ</div>
                    <div style="flex: 1;">
                        <div id="fileText" style="font-weight: 600; color: var(--text-primary);">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                    </div>
                    <div style="padding: 8px 16px; background: var(--primary); color: white; border-radius: var(--border-radius-sm); font-weight: 600; font-size: 14px;">
                        –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 24px; display: flex; gap: 12px; align-items: center;">
            <button id="submitBtn" type="submit" class="btn primary" style="flex: 1; padding: 16px; font-size: 16px; font-weight: 600;">
                <span>üìä</span>
                <span>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF –æ—Ç—á—ë—Ç</span>
            </button>
        </div>
    </form>
    
    <div id="status" style="margin-top: 24px;"></div>
</div>

<script>
    const form = document.getElementById('analyzeForm');
    const status = document.getElementById('status');
    const fileInput = document.getElementById('file');
    const fileDisplay = document.getElementById('fileDisplay');
    const fileText = document.getElementById('fileText');
    const submitBtn = document.getElementById('submitBtn');

    // Update file display when file is selected
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            fileText.innerHTML = `<strong>${file.name}</strong> <span style="color: var(--text-muted); font-size: 12px;">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>`;
            fileDisplay.style.borderColor = 'var(--primary)';
            fileDisplay.style.background = 'rgba(99, 102, 241, 0.05)';
        } else {
            fileText.innerHTML = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏';
            fileDisplay.style.borderColor = 'var(--border-color)';
            fileDisplay.style.background = 'var(--bg-secondary)';
        }
    });

    // Hover effect for file display
    fileDisplay.addEventListener('mouseenter', function() {
        if (!fileInput.files.length) {
            this.style.borderColor = 'var(--primary-light)';
            this.style.background = 'rgba(99, 102, 241, 0.02)';
        }
    });
    fileDisplay.addEventListener('mouseleave', function() {
        if (!fileInput.files.length) {
            this.style.borderColor = 'var(--border-color)';
            this.style.background = 'var(--bg-secondary)';
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        status.innerHTML = '';
        
        if (!fileInput.files.length) {
            status.innerHTML = '<div class="alert error"><span>‚ö†Ô∏è</span><span>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.</span></div>';
            fileDisplay.style.borderColor = 'var(--error)';
            setTimeout(() => {
                if (!fileInput.files.length) {
                    fileDisplay.style.borderColor = 'var(--border-color)';
                }
            }, 3000);
            return;
        }

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span>‚è≥</span><span>–û–±—Ä–∞–±–æ—Ç–∫–∞...</span>';
        submitBtn.style.opacity = '0.7';
        submitBtn.style.cursor = 'not-allowed';

        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        fd.append('plot_name', document.getElementById('plot_name').value || '');
        
        status.innerHTML = '<div class="alert info"><span>üì§</span><span>–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</span></div>';
        
        try {
            const res = await fetch('/api/analyze', { method: 'POST', body: fd });
            if (!res.ok) {
                // handle special 'offer upgrade' response
                if (res.status === 402) {
                    const j = await res.json().catch(() => null);
                    status.innerHTML = '<div class="alert warning"><span>‚ö†Ô∏è</span><div>' + (j && j.message ? j.message : '–õ–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –∏—Å—á–µ—Ä–ø–∞–Ω.') + ' <a href="/app/upgrade" style="color: var(--warning); font-weight: 600;">–ü–µ—Ä–µ–π—Ç–∏ –∫ PRO</a></div></div>';
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<span>üìä</span><span>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF –æ—Ç—á—ë—Ç</span>';
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                    return;
                }
                const text = await res.text();
                throw new Error(text);
            }
            const data = await res.json();
            status.innerHTML = '<div class="alert success"><span>‚úÖ</span><div>–û—Ç—á—ë—Ç –≥–æ—Ç–æ–≤! <a href="/app/reports/' + data.report_id + '" style="color: var(--success); font-weight: 600; text-decoration: underline;">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á—ë—Ç</a></div></div>';
            
            // Reset form
            form.reset();
            fileText.innerHTML = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏';
            fileDisplay.style.borderColor = 'var(--border-color)';
            fileDisplay.style.background = 'var(--bg-secondary)';
        } catch (err) {
            status.innerHTML = '<div class="alert error"><span>‚ùå</span><div>–û—à–∏–±–∫–∞: ' + err.message + '</div></div>';
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>üìä</span><span>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF –æ—Ç—á—ë—Ç</span>';
            submitBtn.style.opacity = '1';
            submitBtn.style.cursor = 'pointer';
        }
    });
</script>
{% endblock %}